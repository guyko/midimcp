# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Kotlin-based Maven project called "midimcp" - a local MCP (Model Context Protocol) server that manages MIDI guitar pedal execution. The server provides persistent knowledge of pedal parameters and executes MIDI CC commands generated by AI assistants. The AI assistant handles natural language interpretation while the MCP server focuses on command execution and pedal management.

## Build Commands

- **Build project**: `mvn compile`
- **Run MCP server**: `mvn exec:java` or `./run-server.sh`
- **Run tests**: `mvn test`
- **Package**: `mvn package`
- **Clean**: `mvn clean`

## Project Architecture

### Core Components

1. **Data Models** (`src/main/java/com/guyko/models/`)
   - `PedalModel`: Represents a guitar pedal with its MIDI CC mappings
   - `CCParameter`: Represents individual MIDI CC parameters (name, CC number, value ranges)
   - `MidiCommand`: Represents generated MIDI commands with byte conversion

2. **MIDI Execution** (`src/main/java/com/guyko/midi/`)
   - `MidiExecutor`: Interface for MIDI command execution
   - `HardwareMidiExecutor`: Real hardware MIDI output
   - `MockMidiExecutor`: Testing implementation with command tracking

3. **Persistence Layer** (`src/main/java/com/guyko/persistence/`)
   - `PedalRepository`: JSON-based storage for pedal configurations using Gson
   - Data stored in `data/pedals/` directory as JSON files

4. **MCP Server** (`src/main/java/com/guyko/mcp/`)
   - `MCPServer`: Main MCP protocol implementation with JSON-RPC communication
   - Handles tool calls for pedal management and MIDI command execution

5. **Pedal Configurations** (`src/main/java/com/guyko/pedals/`)
   - `MerisLVXLoader`: Pre-configured Meris LVX delay pedal with full CC table
   - `MerisMercuryXLoader`: Pre-configured Meris Mercury X reverb pedal with full CC table
   - `MerisEnzoXLoader`: Pre-configured Meris Enzo X synthesizer pedal with full CC table
   - `LVXPresetGenerator`: Generates LVX sysex preset files from CC parameters
   - `MercuryXPresetGenerator`: Generates Mercury X sysex preset files from CC parameters
   - `EnzoXPresetGenerator`: Generates Enzo X sysex preset files from CC parameters

### Available MCP Tools

- `add_pedal`: Add new guitar pedals with MIDI CC mappings
- `get_pedal`: Retrieve specific pedal information
- `list_pedals`: List all available pedals
- `execute_midi_command`: Execute a single MIDI CC command on a pedal
- `execute_midi_commands`: Execute multiple MIDI CC commands in sequence
- `execute_program_change`: Switch pedal presets via MIDI program change
- `generate_lvx_preset`: Generate LVX delay preset sysex files from CC parameters
- `generate_mercury_x_preset`: Generate Mercury X reverb preset sysex files from CC parameters
- `generate_enzo_x_preset`: Generate Enzo X synthesizer preset sysex files from CC parameters
- `get_midi_status`: Get MIDI executor connection status

### Architecture Design

**AI Assistant Responsibilities:**
- Natural language interpretation ("make it brighter" → specific CC commands)
- Musical knowledge and sound design decisions
- Parameter value calculations and relationships

**MCP Server Responsibilities:**
- Pedal knowledge storage and retrieval
- MIDI command validation and execution
- Hardware communication
- Command result reporting

### Preset Generation System

The server includes comprehensive sysex preset generation for Meris pedals:

**Supported Pedals:**
- **LVX Delay**: Complete delay preset generation with all processing elements
- **Mercury X Reverb**: Full reverb preset generation with all 8 reverb structures
- **Enzo X Synthesizer**: Complete synthesizer preset generation with all synth modes

**Architecture:**
- All pedals use identical 231-byte sysex format
- Preset names stored at position 212 (max 16 characters)
- Header patterns and terminator (F7) consistent across pedals
- CC-to-sysex position mapping for each pedal model

**Workflow:**
1. AI assistant interprets natural language → provides CC parameter values
2. MCP server maps CC values to exact sysex byte positions
3. Generates complete 231-byte sysex file ready for pedal upload
4. Returns hex string for immediate MIDI transmission

## Dependencies

- Kotlin 1.3.0 standard library (JDK8)
- Gson 2.8.9 for JSON serialization
- kotlin-logging for logging
- JUnit 4.12 for testing
- Mockito for mocking

## Testing

The project includes comprehensive tests covering the complete workflow:

- **Unit Tests**: Individual component testing (MIDI commands, pedal models, MIDI execution)
- **Integration Tests**: End-to-end workflow testing from AI commands to MIDI output
- **Test Coverage**: 25 focused tests covering all major functionality

Run tests with: `mvn test`

### Test Examples

The tests demonstrate the AI assistant → MCP server execution flow:

1. **AI interprets**: "make it brighter" → AI generates: `MidiCommand(channel=1, cc=5, value=100)`
2. **MCP executes**: Command validation → Hardware execution → Result: `B0 05 64` bytes sent
3. **Batch commands**: AI sends multiple commands → MCP executes sequence → All results reported

Tests include both successful execution and failure scenarios with mock hardware.

## Getting Started

1. Build the project: `mvn compile`
2. Run tests: `mvn test`
3. Run the MCP server: `mvn exec:java`
4. The server will start with pre-loaded Meris pedal configurations:
   - LVX Delay (Channel 2)
   - Mercury X Reverb (Channel 1) 
   - Enzo X Synthesizer (Channel 3)
   - Quad Cortex (Channel 4)
5. Connect your AI assistant to interact via MCP protocol

## Development Environment

- IntelliJ IDEA project configuration included
- Maven build system with Kotlin compilation
- Git configuration with appropriate ignores for Maven/IntelliJ artifacts